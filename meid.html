<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEID Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: background 0.5s ease;
        }
        
        .container {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
            padding: 40px;
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .container:hover {
            transform: translateY(-5px);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        /* Join Channel Screen Styles removed */
        
        /* Input Group Styles */
        .input-group {
            margin-bottom: 25px;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .input-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .token-input {
            width: 100%;
            padding: 15px 15px 15px 45px;
            border: 2px solid #e1e5ee;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            outline: none;
        }
        
        .token-input:focus {
            border-color: #2575fc;
            box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.1);
        }
        
        .input-icon {
            position: absolute;
            left: 15px;
            color: #6a11cb;
            font-size: 18px;
        }
        
        .toggle-visibility {
            position: absolute;
            right: 15px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 18px;
        }
        
        .btn {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .message {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            margin-top: 20px;
            font-size: 14px;
            color: #666;
            text-align: left;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2575fc;
        }
        
        /* Login Tabs Styles */
        .login-tabs {
            display: flex;
            margin-bottom: 25px;
            border-radius: 10px;
            background: #f8f9fa;
            padding: 5px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            color: #666;
        }
        
        .tab-btn.active {
            background: white;
            color: #2575fc;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* OTP Input Styles */
        .otp-timer {
            text-align: center;
            margin: 10px 0;
            font-size: 14px;
            color: #666;
        }
        
        .otp-timer.expiring {
            color: #dc3545;
            font-weight: 600;
        }
        
        .resend-otp {
            background: none;
            border: none;
            color: #2575fc;
            cursor: pointer;
            font-size: 14px;
            text-decoration: underline;
            margin-top: 10px;
        }
        
        .resend-otp:disabled {
            color: #999;
            cursor: not-allowed;
        }
        
        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading .spinner {
            display: inline-block;
        }
        
        .loading .btn-text {
            display: none;
        }
        
        /* Data Screen Styles */
        .data-screen {
            display: none;
        }
        
        .account-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            text-align: left;
            border-left: 5px solid #2575fc;
        }
        
        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .msisdn {
            font-weight: 600;
            color: #333;
            font-size: 18px;
        }
        
        .mytel-badge {
            background: #6a11cb;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .balance-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .balance-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .balance-name {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .balance-amount {
            font-size: 20px;
            font-weight: 700;
            color: #2575fc;
        }
        
        .balance-unit {
            font-size: 14px;
            color: #888;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .logout-btn {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: #e9ecef;
        }
        
        .refresh-btn {
            background: linear-gradient(to right, #00b09b, #96c93d);
            color: white;
            border: none;
            border-radius: 1010px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .play-btn {
            background: linear-gradient(to right, #ff6b6b, #ff8e8e);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .back-btn {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: #e9ecef;
        }
        
        /* Play Screen Styles */
        .play-screen {
            display: none;
        }
        
        .play-screen-init {
            /* Initial state - visible */
        }
        
        .play-screen-ready {
            /* When system is ready */
        }
        
        .play-screen-ready .init-section {
            display: none !important;
        }
        
        .status-display {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
            border-left: 4px solid #00b09b;
        }
        
        .status-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .status-value {
            font-size: 16px;
            font-weight: 600;
        }
        
        .status-ready {
            color: #28a745;
        }
        
        .status-loading {
            color: #ffc107;
        }
        
        .status-error {
            color: #dc3545;
        }
        
        .phone-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5ee;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all 0.3s;
            outline: none;
        }
        
        .phone-input:focus {
            border-color: #00b09b;
            box-shadow: 0 0 0 3px rgba(0, 176, 155, 0.1);
        }
        
        /* Player Info Styles */
        .player-info {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin: 15px 0;
            text-align: left;
            border-left: 5px solid #6a11cb;
            max-height: 200px;
            overflow: hidden;
        }
        
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .player-msisdn {
            font-weight: 600;
            color: #333;
            font-size: 18px;
        }
        
        .player-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 3px;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-name {
            font-size: 10px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 15px;
            font-weight: 700;
            color: #6a11cb;
        }
        .htd-btn {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .htd-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .htd-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .dtt-btn {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .dtt-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .dtt-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .auto-btn {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .auto-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .auto-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .auto-btn-stop {
            background: linear-gradient(to right, #dc3545, #e4606d);
        }
        
        /* Stats Display Styles */
        .stats-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            text-align: center;
            border-left: 4px solid #6a11cb;
        }
        
        .stat-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .stat-data .stat-icon { color: #2575fc; }
        .stat-point .stat-icon { color: #ffc107; }
        .stat-voice .stat-icon { color: #28a745; }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: 700;
        }
        
        .stat-data .stat-value { color: #2575fc; }
        .stat-point .stat-value { color: #ffc107; }
        .stat-voice .stat-value { color: #28a745; }
        
        .stat-unit {
            font-size: 12px;
            color: #888;
            margin-left: 2px;
        }
        
        /* Game Log Styles */
        .game-log {
           background: #f8f9fa;
           border-radius: 12px;
           padding: 20px;
           margin: 25px 0;
           text-align: left;
           border-left: 4px solid #6f42c1;
           max-height: 400px;
           min-height: 250px;
           height: 350px;
           overflow-y: auto;
           display: flex;
           flex-direction: column;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .log-title {
            font-weight: 600;
            color: #333;
        }
        
        .log-clear {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 12px;
        }
        
        .log-content {
            font-family: monospace;
            font-size: 13px;
            line-height: 1.5;
            max-height: 320px;
            height: 320px;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .log-item {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid #eee;
        }
        
        .log-success {
            color: #28a745;
        }
        
        .log-error {
            color: #dc3545;
        }
        
        .log-info {
            color: #17a2b8;
        }
        
        /* Auto scroll animation */
        .log-content {
            scroll-behavior: smooth;
        }
        
        .log-item:last-child {
            animation: highlight 0.5s ease;
        }
        
        @keyframes highlight {
            0% { background-color: rgba(37, 117, 252, 0.1); }
            100% { background-color: transparent; }
        }
        
        /* Hide screens initially */
        #tokenScreen, #dataScreen, #playScreen {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Token Input Screen -->
        <div id="tokenScreen">
            <h1>MEID Dashboard</h1>
            <p class="subtitle">Enter your token to view account details</p>
            
            <!-- Login Method Tabs -->
            <div class="login-tabs">
                <button class="tab-btn active" data-tab="token-tab">Token Login</button>
                <button class="tab-btn" data-tab="otp-tab">Phone/OTP Login</button>
            </div>
            
            <!-- Token Login Tab -->
            <div id="token-tab" class="tab-content active">
                <div class="input-group">
                    <label for="token">Authentication Token</label>
                    <div class="input-container">
                        <i class="fas fa-key input-icon"></i>
                        <input type="password" id="token" class="token-input" placeholder="Enter your Bearer token here">
                        <button type="button" class="toggle-visibility" id="toggleVisibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <button id="startBtn" class="btn">
                    <div class="spinner"></div>
                    <span class="btn-text">Get Account Details</span>
                </button>
            </div>
            
            <!-- OTP Login Tab -->
            <div id="otp-tab" class="tab-content">
                <div class="input-group">
                    <label for="phoneNumberLogin">Phone Number</label>
                    <div class="input-container">
                        <i class="fas fa-phone input-icon"></i>
                        <input type="tel" id="phoneNumberLogin" class="token-input" placeholder="Enter your phone number (09XXXXXXXX)">
                    </div>
                </div>
                
                <div id="otpSection" style="display: none;">
                    <div class="input-group">
                        <label for="otpCode">OTP Code</label>
                        <div class="input-container">
                            <i class="fas fa-sms input-icon"></i>
                            <input type="text" id="otpCode" class="token-input" placeholder="Enter OTP code" maxlength="6">
                        </div>
                    </div>
                </div>
                
                <button id="sendOtpBtn" class="btn">
                    <div class="spinner"></div>
                    <span class="btn-text" id="otpBtnText">Send OTP</span>
                </button>
                
                <button id="verifyOtpBtn" class="btn" style="display: none; margin-top: 10px;">
                    <div class="spinner"></div>
                    <span class="btn-text">Verify OTP</span>
                </button>
            </div>
            
            <div id="message" class="message"></div>
            
            <div class="info">
                <p><strong>How it works:</strong></p>
                <p>1. Enter your Bearer token or login with Phone/OTP</p>
                <p>2. Click "Get Account Details" or "Send OTP"</p>
                <p>3. The system will fetch your account information</p>
                <p>4. Your token will be saved for future use</p>
            </div>
        </div>
        
        <!-- Data Display Screen -->
        <div id="dataScreen" class="data-screen">
            <h1>MEID Details</h1>
            <p class="subtitle">Your account information</p>
            
            <div id="accountsContainer">
                <!-- Account cards will be dynamically inserted here -->
            </div>
            
            <div class="button-group">
                <button id="logoutBtn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <button id="refreshBtn" class="refresh-btn">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
                <button id="playBtn" class="play-btn">
                    <i class="fas fa-play"></i> Play
                </button>
            </div>
        </div>
        
        <!-- Play Screen -->
        <div id="playScreen" class="play-screen play-screen-init">
            <h1 class="init-section">MEID Play</h1>
            <p class="subtitle init-section">System Initialization</p>
            
            <div class="input-group init-section">
                <label for="phoneNumber">Phone Number</label>
                <input type="text" id="phoneNumber" class="phone-input" placeholder="Enter phone number (e.g., 09688888888)">
            </div>
            
            <button id="fetchTokenBtn" class="btn init-section">
                <div class="spinner"></div>
                <span class="btn-text">Initialize System</span>
            </button>
            
            <div id="playMessage" class="message"></div>
            
            <div id="statusDisplay" class="status-display init-section">
                <div class="status-label">System Status:</div>
                <div class="status-value" id="systemStatus">Not initialized</div>
            </div>
            
            
            
            <!-- Player Info Display -->
            <div id="playerInfo" class="player-info" style="display: none;">
                <div class="player-header">
                    <div class="player-msisdn" id="playerMsisdn">-</div>
                    <div class="mytel-badge">Player Info</div>
                </div>
                <div class="player-stats">
                    <div class="stat-item">
                        <div class="stat-name">Golden Heart</div>
                        <div class="stat-value" id="goldenHeart">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-name">Total Turns</div>
                        <div class="stat-value" id="totalTurn">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-name">Remain Turns</div>
                        <div class="stat-value" id="remainTurn">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-name">Diamond</div>
                        <div class="stat-value" id="diamond">-</div>
                    </div>
                </div>
            </div
            <!-- conversion Buttons -->
            <div class="button-group">
                <button id="heartToDia" class="htd-btn" disabled>
                <div class="spinner"></div>
                    <i class="fas fa-heart"></i> အသဲမှစိန်
                </button>
                <button id="diaToTurn" class="dtt-btn" disabled>
                <div class="spinner"></div>
                    <i class="fas fa-gem"></i> စိန်မှကစားခွင့်
                </button>
            </div>
            
            <!-- Stats Display -->
            <div id="statsDisplay" class="stats-display">
                <div class="stat-card stat-data">
                    <div class="stat-icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="stat-label">Data</div>
                    <div class="stat-value">0<span class="stat-unit">MB</span></div>
                </div>
                <div class="stat-card stat-point">
                    <div class="stat-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="stat-label">Points</div>
                    <div class="stat-value">0<span class="stat-unit">PTS</span></div>
                </div>
                <div class="stat-card stat-voice">
                    <div class="stat-icon">
                        <i class="fas fa-phone"></i>
                    </div>
                    <div class="stat-label">Voice</div>
                    <div class="stat-value">0<span class="stat-unit">MIN</span></div>
                </div>
            </div>
            
            <!-- Game Log -->
            <div id="gameLog" class="game-log" style="display: none;">
                <div class="log-header">
                    <div class="log-title">Game Log</div>
                    <button class="log-clear" id="clearLog">Clear</button>
                </div>
                <div class="log-content" id="logContent"></div>
            </div>
            
            <div class="button-group">
                <button id="backToDataBtn" class="logout-btn">
                    <i class="fas fa-arrow-left"></i> Back to Data
                </button>
                <button id="startAutoBtn" class="auto-btn" disabled>
                    <i class="fas fa-robot"></i> Start Auto
                </button>
            </div>
        </div>
    </div>

    <!-- Gateway.js will be dynamically loaded here -->
    <div id="gatewayScriptContainer"></div>

    <script>
        // Telegram Web App Configuration
        const tg = window.Telegram?.WebApp;
        
        // Game state variables
        let otpTimer = null;
        let otpExpiryTime = null;
        let otpRequestId = null;
        let gameState = {
            isAutoRunning: false,
            sessionId: null,
            msisdn: null,
            t1: null,
            t2: null,
            bossId: null,
            wave: 0,
            score: 0,
            playerInfo: null,
            data: 0,      // Data in MB
            point: 0,     // Points
            voice: 0      // Voice minutes
        };

        // Show main app
        function showMainApp() {
            const savedToken = localStorage.getItem('mytelToken');
            if (savedToken) {
                document.getElementById('tokenScreen').style.display = 'none';
                document.getElementById('dataScreen').style.display = 'block';
                fetchAccountData(savedToken);
            } else {
                document.getElementById('tokenScreen').style.display = 'block';
                document.getElementById('dataScreen').style.display = 'none';
            }
        }

        // RSA Encryption Function
        async function encryptRSA(plaintext, publicKeyBase64) {
            return new Promise((resolve, reject) => {
                try {
                    const publicKeyPem = "-----BEGIN PUBLIC KEY-----\r\n" + 
                                        publicKeyBase64 + 
                                        "\r\n-----END PUBLIC KEY-----";

                    const encryptor = new JSEncrypt();
                    encryptor.setPublicKey(publicKeyPem);
                    
                    const encrypted = encryptor.encrypt(plaintext);
                    
                    if (encrypted) {
                        resolve(encrypted);
                    } else {
                        reject(new Error("Encryption failed - possibly invalid public key"));
                    }
                } catch (error) {
                    console.error("Encryption error:", error);
                    reject(error);
                }
            });
        }

        // Global function to update system status
        function updateSystemStatus(message, status) {
            const systemStatusDiv = document.getElementById('systemStatus');
            const statusDisplayDiv = document.getElementById('statusDisplay');
            
            if (systemStatusDiv && statusDisplayDiv) {
                systemStatusDiv.textContent = message;
                systemStatusDiv.className = 'status-value';
                
                if (status === 'ready') {
                    systemStatusDiv.classList.add('status-ready');
                } else if (status === 'loading') {
                    systemStatusDiv.classList.add('status-loading');
                } else if (status === 'error') {
                    systemStatusDiv.classList.add('status-error');
                }
                
                statusDisplayDiv.style.display = 'block';
            }
        }

        // Global function to show play message
        function showPlayMessage(text, type) {
            const playMessageDiv = document.getElementById('playMessage');
            if (playMessageDiv) {
                playMessageDiv.textContent = text;
                playMessageDiv.className = 'message ' + type;
                playMessageDiv.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(() => {
                        playMessageDiv.style.display = 'none';
                    }, 5000);
                }
            }
        }

        // Global function to display player info
        function displayPlayerInfo(playerData) {
            const playerInfoDiv = document.getElementById('playerInfo');
            const playerMsisdn = document.getElementById('playerMsisdn');
            const goldenHeart = document.getElementById('goldenHeart');
            const totalTurn = document.getElementById('totalTurn');
            const remainTurn = document.getElementById('remainTurn');
            const diamond = document.getElementById('diamond');
            const startAutoBtn = document.getElementById('startAutoBtn');
            const diaToTurn = document.getElementById('diaToTurn');
            const heartToDia = document.getElementById('heartToDia');
            
            if (playerData && playerData.result) {
                gameState.playerInfo = playerData.result;
                playerMsisdn.textContent = playerData.result.msisdn || '-';
                goldenHeart.textContent = playerData.result.goldenHeart || '0';
                totalTurn.textContent = playerData.result.turn || '0';
                remainTurn.textContent = playerData.result.remainTurn || '0';
                diamond.textContent = playerData.result.diamond ? 
                    Number(playerData.result.diamond).toLocaleString() : '0';
                
                playerInfoDiv.style.display = 'block';
                startAutoBtn.disabled = false;
                diaToTurn.disabled = false;
                heartToDia.disabled = false;
            }
        }

        // Stats display functions
        function updateStatsDisplay() {
            const statsDisplay = document.getElementById('statsDisplay');
            const dataValue = document.querySelector('.stat-data .stat-value');
            const pointValue = document.querySelector('.stat-point .stat-value');
            const voiceValue = document.querySelector('.stat-voice .stat-value');
            
            if (statsDisplay && dataValue && pointValue && voiceValue) {
                // Update values
                dataValue.innerHTML = gameState.data + '<span class="stat-unit">MB</span>';
                pointValue.innerHTML = gameState.point + '<span class="stat-unit">PTS</span>';
                voiceValue.innerHTML = gameState.voice + '<span class="stat-unit">MIN</span>';
                
                // Show/hide based on values
                const dataCard = document.querySelector('.stat-data');
                const pointCard = document.querySelector('.stat-point');
                const voiceCard = document.querySelector('.stat-voice');
                
                dataCard.style.display = gameState.data !== 0 ? 'block' : 'none';
                pointCard.style.display = gameState.point !== 0 ? 'block' : 'none';
                voiceCard.style.display = gameState.voice !== 0 ? 'block' : 'none';
                
                // Show stats display if at least one value is not zero
                const shouldShow = gameState.data !== 0 || gameState.point !== 0 || gameState.voice !== 0;
                statsDisplay.style.display = shouldShow ? 'grid' : 'none';
            }
        }

        // Process end game prizes
        function processEndGamePrizes(claimedPrizes) {
            if (!claimedPrizes || !Array.isArray(claimedPrizes)) return;
            
            let totalData = 0;
            let totalPoints = 0;
            let totalVoice = 0;
            
            claimedPrizes.forEach(prize => {
                const prizeCode = prize.prizeCode;
                const amount = prize.amount || 0;
                
                if (prizeCode.includes('RD_DATA')) {
                    totalData += amount;
                    //addGameLog(`End Game Prize: DATA ${amount}MB`, 'success');
                } else if (prizeCode.includes('RD_LOYALTY')) {
                    totalPoints += amount;
                    //addGameLog(`End Game Prize: POINTS ${amount}PTS`, 'success');
                } else if (prizeCode.includes('RD_VOICE')) {
                    totalVoice += amount;
                    //addGameLog(`End Game Prize: VOICE ${amount}MIN`, 'success');
                }
            });
            
            // Update game state
            if (totalData > 0) {
                gameState.data += totalData;
                addGameLog(`Total DATA earned: ${totalData}MB`, 'success');
            }
            if (totalPoints > 0) {
                gameState.point += totalPoints;
                addGameLog(`Total POINTS earned: ${totalPoints}PTS`, 'success');
            }
            if (totalVoice > 0) {
                gameState.voice += totalVoice;
                addGameLog(`Total VOICE earned: ${totalVoice}MIN`, 'success');
            }
            
            // Update display
            updateStatsDisplay();
        }

        // Game log functions
        function addGameLog(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const gameLog = document.getElementById('gameLog');
            
            if (logContent && gameLog) {
                const logItem = document.createElement('div');
                logItem.className = `log-item log-${type}`;
                logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContent.appendChild(logItem);
                
                logContent.scrollTop = logContent.scrollHeight;
                gameLog.style.display = 'block';
                
                setTimeout(() => {
                    logItem.style.animation = 'highlight 0.5s ease';
                    setTimeout(() => {
                        logItem.style.animation = '';
                    }, 500);
                }, 10);
            }
        }

        function clearGameLog() {
            const logContent = document.getElementById('logContent');
            if (logContent) {
                logContent.innerHTML = '';
            }
        }
        
        async function buyTurn() {
        
            if (!gameState.isAutoRunning) {
                document.getElementById('diaToTurn').classList.add('loading');
                document.getElementById('diaToTurn').disabled = true;
                try {
                const result = await window.apis?.buyTurn();
                document.getElementById('diaToTurn').classList.remove('loading');
                document.getElementById('diaToTurn').disabled = false;
                if (result.success === true) {
                    //addGameLog(JSON.stringify(result), 'success');
                    window.getPlayerInfo();
                    if (result.message) {
                        addGameLog(`${result.message}`, 'success');
                        addGameLog(`Diamond > ${result.result.diamond}`, 'success');
                        addGameLog(`Turn > ${result.result.amountTurn}`, 'success');
                    } else {
                        addGameLog(`No response`, 'error');
                    }
                } else {
                    addGameLog(`${result.error.message}`, 'error');
                }
            } catch (error) {
                addGameLog(`buy turn error: ${error}`, 'error');
                document.getElementById('diaToTurn').classList.remove('loading');
                document.getElementById('diaToTurn').disabled = false;
            }
            } else {
                addGameLog('stop auto play first.', 'info');
                document.getElementById('diaToTurn').classList.remove('loading');
                document.getElementById('diaToTurn').disabled = false;
            }
        }
        // Auto game loop functions
        async function startAutoGame() {
            if (!gameState.isAutoRunning) {
                gameState.isAutoRunning = true;
                gameState.wave = 0;
                gameState.score = 0;
                // Don't reset data, point, voice - keep accumulating
                
                const startAutoBtn = document.getElementById('startAutoBtn');
                startAutoBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Auto';
                startAutoBtn.classList.add('auto-btn-stop');
                
                addGameLog('Auto game started', 'info');
                gameLoop();
            } else {
                stopAutoGame();
            }
        }

        function stopAutoGame() {
            gameState.isAutoRunning = false;
            
            const startAutoBtn = document.getElementById('startAutoBtn');
            startAutoBtn.innerHTML = '<i class="fas fa-robot"></i> Start Auto';
            startAutoBtn.classList.remove('auto-btn-stop');
            
            addGameLog('Auto game stopped', 'info');
        }

        async function gameLoop() {
            let consecutiveErrors = 0;
            const MAX_CONSECUTIVE_ERRORS = 3;
            
            while (gameState.isAutoRunning) {
                try {
                    consecutiveErrors = 0;
                    await createGame();
                    
                    if (!gameState.isAutoRunning) break;
                    
                    let waveSuccess = true;
                    while (gameState.wave < 19 && gameState.isAutoRunning) {
                        try {
                            await nextWave();
                        } catch (waveError) {
                            addGameLog(`Wave ${gameState.wave} error: ${waveError.message}`, 'error');
                        }
                        gameState.wave++;
                        try {
                            //if (!gameState.isAutoRunning) break;
                            
                            const killResult = await killBoss();
                            
                            if (!gameState.isAutoRunning) break;

                        } catch (killError) {
                            if (Object.keys(killError).length === 0) {
                                addGameLog(`Wave ${gameState.wave} Killboss error.`, 'error');
                            } else {
                                addGameLog(`Wave ${gameState.wave} Killboss error: ${killError.message}`, 'error');
                            }
                        }
                    }
                    
                    if (gameState.wave >= 19) {
                        try {
                            var n = gameState.t1,
                                o = gameState.t2,
                                r = gameState.msisdn,
                                i = (gameState.sessionId, o),
                                f = Math.floor(gameState.score);
                                l = n,
                                h = "984271",
                                g = "1243";
                            
                            var v = l + "_@@_0_@@_"+ h + "_@@_"+ r + "_@@_"+ f + "_@@_" + g;
                            const b = await encryptRSA(v, i);
                            const doubleScore = (4 * gameState.score).toString();
                            const tripleH = (3 * parseInt(h)).toString();
                            addGameLog('Ending game', 'info');
                            const endResult =await window.apis?.createEndGame(b, doubleScore, tripleH);
    
                            if (endResult && endResult.success && endResult.result && endResult.result.claimedPrizes) {
                               processEndGamePrizes(endResult.result.claimedPrizes);
                               addGameLog('Game completed successfully.', 'success');
                                   } else {
                                       addGameLog('Game completed but no prizes received', 'info');
                                   }
                               } catch (endError) {
                                   if (endError.message.includes('timeout')) {
                                       addGameLog('End game request timeout', 'error');
                                   } else {
                                       addGameLog(`End game error: ${endError.message}`, 'error');
                                   }
                               }
                        
                        gameState.wave = 0;
                        gameState.score = 0;
                        
                    }
                } catch (error) {
                    consecutiveErrors++;
                    addGameLog(`Game loop error: ${error.message}`, 'error');
                    
                    if (consecutiveErrors >= MAX_CONSECUTIVE_ERRORS) {
                        addGameLog(`Too many consecutive errors (${consecutiveErrors}), stopping auto game`, 'error');
                        stopAutoGame();
                        break;
                    }
                    
                    const waitTime = 2000 * consecutiveErrors;
                    addGameLog(`Waiting ${waitTime/1000} seconds before retry...`, 'info');
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
        }

        async function createGame() {
            addGameLog('Creating new game...', 'info');
            
            try {
                gameState.bossId = null;
                
                const result = await window.apis?.createGame("WORLD", "LUCUS") || {
                    success: true,
                    result: {
                        sessionId: 'session_' + Date.now(),
                        msisdn: gameState.msisdn || '09688888888',
                        t1: 't1_' + Math.random().toString(36).substring(2),
                        t2: 'MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA' + Math.random().toString(36).substring(2)
                    }
                };
                
                if (result.success) {
                    gameState.sessionId = result.result.sessionId;
                    gameState.msisdn = result.result.msisdn;
                    gameState.t1 = result.result.t1;
                    gameState.t2 = result.result.t2;
                    gameState.wave = 0;
                    gameState.score = 0;
                    
                    addGameLog(`Game created successfully.`, 'success');
                    return true;
                } else {
                    throw new Error(`Create game failed: ${result.message}`);
                }
            } catch (error) {
                addGameLog(`Create game error: ${error.message}`, 'error');
                throw error;
            }
        }

        async function nextWave() {
            try {
                const result = await window.apis?.nextWave(gameState.wave.toString(), "WORLD") || {
                    success: true,
                    result: {
                        bossIds: ['boss_' + Math.random().toString(36).substring(2)]
                    }
                };
                
                if (result.success) {
                    if (result.result.bossIds && result.result.bossIds.length > 0) {
                        gameState.bossId = result.result.bossIds[0];
                        return true;
                    } else {
                        throw new Error('No boss IDs returned from server');
                    }
                } else {
                    throw new Error(`Next wave failed: ${result.message}`);
                }
            } catch (error) {
                addGameLog(`Next wave error: ${error.message}`, 'error');
                gameState.sessionId = null;
                throw error;
            }
        }

        function simplePrizeProcessor(prizeCode) {
            if (!prizeCode) return 'No prize';
            
            let result = prizeCode
                .replace('RD_', '')
                .replace(/_/g, ' - ')
                .replace('DATA', '📶Mobile Data')
                .replace('LOYALTY', '🏆Loyalty Points')
                .replace('DIA', '💎Diamonds')
                .replace('VOICE', '🎤Voice Minutes')
                .replace('SMS', '💬SMS')
                .replace('S1', '📱SIM 1')
                .replace('STAR', '⭐Stars');
            
            if (result.includes('Mobile Data') && !result.includes('MB')) {
                result += ' MB';
            }
            if (result.includes('S1') || result.includes('S2')|| result.includes('S3')|| result.includes('S4')|| result.includes('S5')|| result.includes('S6')|| result.includes('S7')|| result.includes('S8')|| result.includes('S9')) {
                result = result.replace('S', '📱SIM ');
            }
            
            return result;
        }

        async function killBoss() {
            if (!gameState.bossId || gameState.bossId.trim() === '') {
                addGameLog('Invalid boss ID, recreating game...', 'error');
                gameState.sessionId = null;
                return false;
            }
            
            if (!gameState.t1 || !gameState.t2 || !gameState.sessionId || !gameState.msisdn) {
                addGameLog('Missing required game state parameters', 'error');
                return false;
            }
            
            if (gameState.wave === 0) {
                gameState.score = 577;
            } else {
                gameState.score += 9800;
            }
            
            const U = `${gameState.t1}_@@_${gameState.sessionId}_@@_${gameState.msisdn}_@@_${gameState.score}_@@_${gameState.t1}`;
            
            try {
                const j = await encryptRSA(U, gameState.t2);
                const bossIdString = Array.isArray(gameState.bossId) ? gameState.bossId[0] : gameState.bossId;
                const doubleScore = (2 * gameState.score).toString();
                
                const result = await window.apis?.killBoss(j, doubleScore, bossIdString, "WORLD") || {
                    success: true,
                    result: {
                        prizeCode: 'RD_DATA_100MB'
                    }
                };
                
                if (result.success) {
                    const prizeCode = result.result.prizeCode ? result.result.prizeCode : 'No prize';
                    const processedPrize = simplePrizeProcessor(prizeCode);
                    addGameLog(`Wave ${gameState.wave} Prize: ${processedPrize}`, 'success');
                    
                    return true;
                } else {
                    if (result.message && (result.message.includes('Session ID is not OK')) || result.message && (result.message.includes('invalid response was received from'))) {
                        //addGameLog(`API Error[1347]: ${result.message || 'Unknown error'}`, 'error');
                        stopAutoGame();
                        showPlayMessage('သတိပေးစာရရှိခြင်းကြောင့် Auto Play ရပ်လိုက်သည်၊ Auto Play ပြန်နှိပ်နိုင်သည်', 'error');
                        return false;
                    } else {
                        return false;
                    }
                }
                
            } catch (error) {
                addGameLog(`Kill boss failed: ${error.message}`, 'error');
                return false;
            }
        }

        window.systemReady = function() {
            if (window.apis) {
                console.log('System is ready');
                updateSystemStatus('System is ready!', 'ready');
                
                const playScreen = document.getElementById('playScreen');
                playScreen.classList.remove('play-screen-init');
                playScreen.classList.add('play-screen-ready');
                
                if(typeof window.apis !== 'undefined'){
                    showPlayMessage('System initialized successfully!', 'success');
                    document.getElementById('startAutoBtn').disabled = false;
                    document.getElementById('diaToTurn').disabled = false;
                    document.getElementById('heartToDia').disabled = false;
                    window.changeLanguage();
                    window.getPlayerInfo();
                } else {
                    showPlayMessage('window.apis undefined', 'error');
                }
                
            } else {
                console.error('Failed to get game APIs');
                updateSystemStatus('Failed to initialize system', 'error');
                showPlayMessage('Failed to initialize system APIs', 'error');
            }
        };
        
        window.changeLanguage = function() {
            setTimeout(() => {
                if (window.apis && typeof window.apis.setLanguage === 'function') {
                    window.apis.setLanguage('my').then(result => {
                    }).catch(error => {
                    });
                } 
            }, 500);
        }
        
        window.getPlayerInfo = function() {
            setTimeout(() => {
                if (window.apis && typeof window.apis.getPlayerInfo === 'function') {
                    window.apis.getPlayerInfo().then(result => {
                        displayPlayerInfo(result);
                    }).catch(error => {
                        console.error('Error getting player info:', error);
                        showPlayMessage('Error getting player info: ' + error.message, 'error');
                        updateSystemStatus('Failed to load player data', 'error');
                    });
                } else {
                    const mockPlayerData = {
                        result: {
                            msisdn: document.getElementById('phoneNumber').value || '09688888888',
                            goldenHeart: Math.floor(Math.random() * 1000),
                            turn: 50,
                            remainTurn: 25,
                            diamond: Math.floor(Math.random() * 5000)
                        }
                    };
                    displayPlayerInfo(mockPlayerData);
                }
            }, 100);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            if (tg) {
                tg.expand();
                tg.enableClosingConfirmation();
            }
            
            // Directly show main app without channel membership check
            showMainApp();
            
            document.getElementById('toggleVisibility').addEventListener('click', function() {
                const tokenInput = document.getElementById('token');
                const icon = this.querySelector('i');
                
                if (tokenInput.type === 'password') {
                    tokenInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    tokenInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
            
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            document.getElementById('startBtn').addEventListener('click', function() {
                const token = document.getElementById('token').value.trim();
                
                if (!token) {
                    showMessage('Please enter your token', 'error');
                    return;
                }
                
                this.classList.add('loading');
                this.disabled = true;
                
                fetchAccountData(token);
            });
            
            document.getElementById('sendOtpBtn').addEventListener('click', function() {
                const phoneNumber = document.getElementById('phoneNumberLogin').value.trim();
                
                if (!phoneNumber) {
                    showMessage('Please enter your phone number', 'error');
                    return;
                }
                
                if (!isValidMyanmarPhone(phoneNumber)) {
                    showMessage('Please enter a valid Myanmar phone number (09XXXXXXXX)', 'error');
                    return;
                }
                
                this.classList.add('loading');
                this.disabled = true;
                
                sendOtpRequest(phoneNumber);
            });
            
            document.getElementById('verifyOtpBtn').addEventListener('click', function() {
                const otpCode = document.getElementById('otpCode').value.trim();
                
                if (!otpCode || otpCode.length !== 6) {
                    showMessage('Please enter a valid 6-digit OTP code', 'error');
                    return;
                }
                
                this.classList.add('loading');
                this.disabled = true;
                
                verifyOtpRequest(otpCode);
            });
            
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('mytelToken');
                localStorage.removeItem('mytelAccounts');
                document.getElementById('tokenScreen').style.display = 'block';
                document.getElementById('dataScreen').style.display = 'none';
                document.getElementById('token').value = '';
                document.getElementById('startBtn').disabled = true;
                showMessage('You have been logged out', 'success');
            });
            
            document.getElementById('refreshBtn').addEventListener('click', function() {
                const token = localStorage.getItem('mytelToken');
                if (token) {
                    this.classList.add('loading');
                    this.disabled = true;
                    fetchAccountData(token);
                }
            });
            
            document.getElementById('playBtn').addEventListener('click', function() {
                document.getElementById('dataScreen').style.display = 'none';
                document.getElementById('playScreen').style.display = 'block';
                
                const accounts = JSON.parse(localStorage.getItem('mytelAccounts') || '[]');
                if (accounts.length > 0) {
                    document.getElementById('phoneNumber').value = accounts[0].msisdn;
                }
                
                updateSystemStatus('Not initialized', '');
                document.getElementById('playerInfo').style.display = 'none';
                document.getElementById('gameLog').style.display = 'none';
                document.getElementById('statsDisplay').style.display = 'none';
                clearGameLog();
                
                document.getElementById('startAutoBtn').disabled = true;
                document.getElementById('diaToTurn').disabled = true;
                document.getElementById('heartToDia').disabled = true;
                document.getElementById('startAutoBtn').innerHTML = '<i class="fas fa-robot"></i> Start Auto';
                document.getElementById('startAutoBtn').classList.remove('auto-btn-stop');
            });
            
            document.getElementById('backToDataBtn').addEventListener('click', function() {
                stopAutoGame();
                document.getElementById('playScreen').style.display = 'none';
                document.getElementById('dataScreen').style.display = 'block';
            });
            
            document.getElementById('startAutoBtn').addEventListener('click', startAutoGame);
            document.getElementById('diaToTurn').addEventListener('click', buyTurn);
           // document.getElementById('heartToDia').addEventListener('click', heartToDiamond);
            document.getElementById('heartToDia').addEventListener('click', function() {})
            
            document.getElementById('clearLog').addEventListener('click', clearGameLog);
            
            document.getElementById('fetchTokenBtn').addEventListener('click', function() {
                const token = localStorage.getItem('mytelToken');
                const phoneNumber = document.getElementById('phoneNumber').value.trim();
                
                if (!phoneNumber) {
                    showPlayMessage('Please enter a phone number', 'error');
                    return;
                }
                
                if (!token) {
                    showPlayMessage('No authentication token found. Please login again.', 'error');
                    return;
                }
                
                this.classList.add('loading');
                this.disabled = true;
                updateSystemStatus('Initializing system...', 'loading');
                
                fetchMyIDToken(token, phoneNumber);
            });
            
            document.getElementById('token').addEventListener('input', function() {
                document.getElementById('startBtn').disabled = this.value.trim() === '';
            });
            
            document.getElementById('phoneNumberLogin').addEventListener('input', function() {
                document.getElementById('sendOtpBtn').disabled = this.value.trim() === '';
            });
            
            document.getElementById('otpCode').addEventListener('input', function() {
                document.getElementById('verifyOtpBtn').disabled = this.value.trim().length !== 6;
            });
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('sendOtpBtn').disabled = true;
            document.getElementById('verifyOtpBtn').disabled = true;
        });
        
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            if (messageDiv) {
                messageDiv.textContent = text;
                messageDiv.className = 'message ' + type;
                messageDiv.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 5000);
                }
            }
        }
        
        function isValidMyanmarPhone(phone) {
            const myanmarPhoneRegex = /^09[0-9]{7,9}$/;
            return myanmarPhoneRegex.test(phone);
        }
        
        async function sendOtpRequest(phoneNumber) {
            const sendOtpBtn = document.getElementById('sendOtpBtn');
            
            try {
                const response = await fetch('https://apis.mytel.com.mm/myid/authen/v1.0/login/method/otp/get-otp?phoneNumber=' + phoneNumber);
                
                if (response.ok) {
                    otpRequestId = phoneNumber;
                    startOtpTimer(60);
                    
                    document.getElementById('otpSection').style.display = 'block';
                    document.getElementById('verifyOtpBtn').style.display = 'block';
                    sendOtpBtn.style.display = 'none';
                    
                    showMessage('OTP sent successfully to ' + phoneNumber, 'success');
                } else {
                    throw new Error('Failed to send OTP');
                }
                
            } catch (error) {
                console.error('OTP Send Error:', error);
                showMessage('Failed to send OTP: ' + error.message, 'error');
            } finally {
                sendOtpBtn.classList.remove('loading');
                sendOtpBtn.disabled = false;
            }
        }
        
        async function verifyOtpRequest(otpCode) {
            const verifyOtpBtn = document.getElementById('verifyOtpBtn');
            const phoneNumber = document.getElementById('phoneNumberLogin').value.trim();
            
            try {
                const response = await fetch('https://apis.mytel.com.mm/myid/authen/v1.0/login/method/otp/validate-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phoneNumber: phoneNumber,
                        password: otpCode,
                        appVersion: '1.0.93',
                        buildVersionApp: '217',
                        deviceId: '0',
                        imei: '0',
                        os: 'MEID auto play bot',
                        osAp: 'IOS',
                        version: ''
                    })
                });
                
                const data = await response.json();
                
                if (data.errorCode === 200 && data.result && data.result.access_token) {
                    const token = data.result.access_token;
                    
                    localStorage.setItem('mytelToken', token);
                    showMessage('OTP verified successfully!', 'success');
                    
                    setTimeout(() => {
                        document.getElementById('tokenScreen').style.display = 'none';
                        document.getElementById('dataScreen').style.display = 'block';
                        fetchAccountData(token);
                    }, 1000);
                    
                } else {
                    throw new Error(data.message || 'Invalid OTP or token not received');
                }
                
            } catch (error) {
                console.error('OTP Verify Error:', error);
                showMessage('OTP verification failed: ' + error.message, 'error');
            } finally {
                verifyOtpBtn.classList.remove('loading');
                verifyOtpBtn.disabled = false;
            }
        }
        
        function startOtpTimer(seconds) {
            const otpTimerElement = document.createElement('div');
            otpTimerElement.className = 'otp-timer';
            otpTimerElement.id = 'otpTimer';
            
            const otpSection = document.getElementById('otpSection');
            const existingTimer = document.getElementById('otpTimer');
            if (existingTimer) {
                existingTimer.remove();
            }
            otpSection.appendChild(otpTimerElement);
            
            otpExpiryTime = Date.now() + (seconds * 1000);
            
            otpTimer = setInterval(() => {
                const now = Date.now();
                const remaining = Math.max(0, Math.floor((otpExpiryTime - now) / 1000));
                
                if (remaining <= 0) {
                    clearInterval(otpTimer);
                    otpTimerElement.innerHTML = 'OTP expired. <button class="resend-otp" id="resendOtp">Resend OTP</button>';
                    document.getElementById('resendOtp').addEventListener('click', resendOtp);
                } else {
                    const minutes = Math.floor(remaining / 60);
                    const secs = remaining % 60;
                    otpTimerElement.textContent = `OTP expires in: ${minutes}:${secs.toString().padStart(2, '0')}`;
                    
                    if (remaining <= 30) {
                        otpTimerElement.classList.add('expiring');
                    }
                }
            }, 1000);
        }
        
        function resendOtp() {
            const phoneNumber = document.getElementById('phoneNumberLogin').value.trim();
            if (phoneNumber) {
                sendOtpRequest(phoneNumber);
            }
        }
        
        function resetOtpLogin() {
            if (otpTimer) {
                clearInterval(otpTimer);
            }
            
            document.getElementById('otpSection').style.display = 'none';
            document.getElementById('verifyOtpBtn').style.display = 'none';
            document.getElementById('sendOtpBtn').style.display = 'flex';
            document.getElementById('otpBtnText').textContent = 'Send OTP';
            
            const otpTimerElement = document.getElementById('otpTimer');
            if (otpTimerElement) {
                otpTimerElement.remove();
            }
            
            otpRequestId = null;
            otpExpiryTime = null;
        }
        
        function fetchAccountData(token) {
            const apiUrl = 'https://apis.mytel.com.mm/account-detail/api/v1.2/individual/account-main?isdn=09688888888&language=en';
            
            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('startBtn').classList.remove('loading');
                document.getElementById('startBtn').disabled = false;
                document.getElementById('refreshBtn').classList.remove('loading');
                document.getElementById('refreshBtn').disabled = false;
                
                if (data.errorCode === 0) {
                    localStorage.setItem('mytelToken', token);
                    localStorage.setItem('mytelAccounts', JSON.stringify(data.result));
                    
                    document.getElementById('tokenScreen').style.display = 'none';
                    document.getElementById('dataScreen').style.display = 'block';
                    
                    displayAccountData(data.result);
                } else {
                    showMessage(`API Error[1820]: ${data.message || 'Unknown error'}`, 'error');
                }
            })
            .catch(error => {
                document.getElementById('startBtn').classList.remove('loading');
                document.getElementById('startBtn').disabled = false;
                document.getElementById('refreshBtn').classList.remove('loading');
                document.getElementById('refreshBtn').disabled = false;
                
                showMessage('Failed to fetch account data. Please check your token and try again.', 'error');
                console.error('Error:', error);
            });
        }
        
        function displayAccountData(accounts) {
            const accountsContainer = document.getElementById('accountsContainer');
            accountsContainer.innerHTML = '';
            
            accounts.forEach(account => {
                const accountCard = document.createElement('div');
                accountCard.className = 'account-card';
                
                accountCard.innerHTML = `
                    <div class="account-header">
                        <div class="msisdn">${account.msisdn}</div>
                        ${account.mytel ? '<div class="mytel-badge">Mytel</div>' : ''}
                    </div>
                    <div class="balance-grid">
                        <div class="balance-item">
                            <div class="balance-name">${account.mainBalance.main.name}</div>
                            <div class="balance-amount">${account.mainBalance.main.amount}</div>
                            <div class="balance-unit">${account.mainBalance.main.unit}</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-name">${account.mainBalance.promo.name}</div>
                            <div class="balance-amount">${account.mainBalance.promo.amount}</div>
                            <div class="balance-unit">${account.mainBalance.promo.unit}</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-name">${account.mainBalance.voice.name}</div>
                            <div class="balance-amount">${account.mainBalance.voice.amount}</div>
                            <div class="balance-unit">${account.mainBalance.voice.unit}</div>
                        </div>
                        <div class="balance-item">
                            <div class="balance-name">${account.mainBalance.data.name}</div>
                            <div class="balance-amount">${account.mainBalance.data.amount}</div>
                            <div class="balance-unit">${account.mainBalance.data.unit}</div>
                        </div>
                    </div>
                `;
                
                accountsContainer.appendChild(accountCard);
            });
        }
        
        function fetchMyIDToken(token, phoneNumber) {
    const phpBackendUrl = 'fetch_token.php'; 
    
    fetch(phpBackendUrl, {
        method: 'GET',
        headers: {
            'access-token': token,
            'phone-number': phoneNumber
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.token) {
            const extractedToken = data.token;
            window.token = extractedToken;
            console.log('Token extracted and set:', extractedToken);
            loadGatewayJS();
        } else {
            document.getElementById('fetchTokenBtn').classList.remove('loading');
            document.getElementById('fetchTokenBtn').disabled = false;
            updateSystemStatus(data.message || 'No token found in response', 'error');
            showPlayMessage(data.message || 'No token found in the response', 'error');
        }
    })
    .catch(error => {
        document.getElementById('fetchTokenBtn').classList.remove('loading');
        document.getElementById('fetchTokenBtn').disabled = false;
        updateSystemStatus('Failed to fetch token', 'error');
        showPlayMessage('Failed to fetch token from MyID. Please try again.', 'error');
        console.error('Error:', error);
    });
}
        
        function loadGatewayJS() {
            const gatewayScript = document.createElement('script');
            gatewayScript.src = 'mjs/gateway.js';
            gatewayScript.onload = function() {
                console.log('gateway.js loaded successfully');
                initializeSystem();
            };
            gatewayScript.onerror = function() {
                document.getElementById('fetchTokenBtn').classList.remove('loading');
                document.getElementById('fetchTokenBtn').disabled = false;
                updateSystemStatus('Failed to load gateway.js', 'error');
                showPlayMessage('Failed to load gateway.js. Please try again.', 'error');
            };
            
            document.getElementById('gatewayScriptContainer').innerHTML = '';
            document.getElementById('gatewayScriptContainer').appendChild(gatewayScript);
        }
        
        function initializeSystem() {
            try {
                if (typeof getGameApis === 'function') {
                    window.apis = getGameApis();
                    
                    if (window.apis && typeof window.apis === 'object') {
                        console.log('APIs object received:', window.apis);
                        
                        document.getElementById('fetchTokenBtn').classList.remove('loading');
                        document.getElementById('fetchTokenBtn').disabled = false;
                        
                        setTimeout(() => {
                            window.systemReady();
                        }, 200);
                    } else {
                        throw new Error('getGameApis returned invalid object: ' + typeof window.apis);
                    }
                } else {
                    throw new Error('getGameApis function not found');
                }
            } catch (error) {
                document.getElementById('fetchTokenBtn').classList.remove('loading');
                document.getElementById('fetchTokenBtn').disabled = false;
                updateSystemStatus('System initialization failed', 'error');
                showPlayMessage('System initialization failed: ' + error.message, 'error');
                console.error('Error initializing system:', error);
            }
        }
    </script>
</body>
</html>
